"main";"use strict";;_8a1‍.x([["io",()=>io]]);let express;_8a1‍.w("express",[["default",["express"],function(v){express=v}]]);let http;_8a1‍.w("http",[["default",["http"],function(v){http=v}]]);let path;_8a1‍.w("path",[["default",["path"],function(v){path=v}]]);let socketIO;_8a1‍.w("socket.io",[["default",["socketIO"],function(v){socketIO=v}]]);let getUserDb,writeDbFile,readDataDirectory,savePlayer,getDbFile,dbFileNameByUsername;_8a1‍.w("./modules/userController",[["getUserDb",["getUserDb"],function(v){getUserDb=v}],["writeDbFile",["writeDbFile"],function(v){writeDbFile=v}],["readDataDirectory",["readDataDirectory"],function(v){readDataDirectory=v}],["savePlayer",["savePlayer"],function(v){savePlayer=v}],["getDbFile",["getDbFile"],function(v){getDbFile=v}],["dbFileNameByUsername",["dbFileNameByUsername"],function(v){dbFileNameByUsername=v}]]);let players,bullets,walls,updatePlayers,updateBullets;_8a1‍.w("./modules/Game.js",[["players",["players"],function(v){players=v}],["bullets",["bullets"],function(v){bullets=v}],["walls",["walls"],function(v){walls=v}],["updatePlayers",["updatePlayers"],function(v){updatePlayers=v}],["updateBullets",["updateBullets"],function(v){updateBullets=v}]]);let Player;_8a1‍.w("./modules/Player.js",[["Player",["Player"],function(v){Player=v}]]);let BotPlayer;_8a1‍.w("./modules/BotPlayer.js",[["BotPlayer",["BotPlayer"],function(v){BotPlayer=v}]]);let runMain;_8a1‍.w("module",[["runMain",["runMain"],function(v){runMain=v}]]);let resolve;_8a1‍.w("url",[["resolve",["resolve"],function(v){resolve=v}]]);
_8a1‍.g.console.clear();
_8a1‍.g.console.log(process.version);



























const app = _8a1‍.a("express",express)();
const server = _8a1‍.a("http",http).Server(app);
       const io = _8a1‍.a("socketIO",socketIO)(server);;_8a1‍.u(["io"]);

//readDataDirectory().then(val => console.log(val));

//getUserDb("abc").then(val => console.log(val));

//writeDbFile("me", { a: 5 });

const bot = new (_8a1‍.a("BotPlayer",BotPlayer))({ nickname: "bot", pass: "tob" });

_8a1‍.a("players",players)[bot.id] = bot;

//console.log(JSON.parse(players[bot.id].jsonObj()));

/*
export let savePlayer = function(player) {
  let jso = player.jso();
  let playerData = db
    .get("Players")
    .find({ nickname: player.nickname, pass: player.pass })
    .assign({
      id: player.id,
      Ttl: Date.now(),
      x: player.x,
      y: player.y,
      width: player.width,
      height: player.height,
      angle: player.angle,
      speed: player.speed,
      rotationSpeed: player.rotationSpeed,
      nickname: player.nickname,
      pass: player.pass,
      maxHealth: player.maxHealth,
      point: player.point,
      Level: player.Level,
      Exp: player.Exp,
      Attack: player.Attack,
      Defense: player.Defense
    })
    .write();
};
*/
io.on("connection", socket => {
  _8a1‍.g.console.log("io.on connection");

  let player = null;

  socket.on("error", error => {
    _8a1‍.g.console.log(socket.id + " error " + error);
  });

  socket.on("validate-user", config => {
    _8a1‍.g.console.log("validate-user");
    _8a1‍.g.console.log(config);
    _8a1‍.a("getUserDb",getUserDb)(config.nickname).then(val => {
      _8a1‍.g.console.log(val);
      if (config.pass === val.pass) {
        player = new (_8a1‍.a("Player",Player))({
          socketId: socket.id,
          nickname: config.nickname,
          pass: config.password
        });
        player.x = val.x;
        player.y = val.y;
        player.width = val.width;
        player.height = val.height;
        player.angle = val.angle;
        player.speed = val.speed;
        player.rotationSpeed = val.rotationSpeed;
        player.nickname = val.nickname;
        player.pass = val.pass;
        player.maxHealth = val.maxHealth;
        player.point = val.point;
        player.Level = val.Level;
        player.Exp = val.Exp;
        player.Attack = val.Attack;
        player.Defense = val.Defense;
        socket.emit("validPlayer", {});
      }
    });
  });
  socket.on("new-user", config => {
    _8a1‍.g.console.log(config);
    _8a1‍.g.console.log("new-user");
    let found = false;
    _8a1‍.a("readDataDirectory",readDataDirectory)()
      .then(val => {
        //dbFileNameByUsername(config.nickname);
        //console.log(val);
        val.forEach(element => {
          _8a1‍.g.console.log(element);
          _8a1‍.a("getDbFile",getDbFile)(element).then(val => {
            _8a1‍.g.console.log(":::" + val.nickname);
            if (val.nickname === config.nickname) {
              found = true;
            }
          });
        });
        return found;
        _8a1‍.g.console.log("------------------");
        /*
        let taken = false;
        for (let i = 0; i <= val.length; i++) {
          console.log(val[i]);
          console.log(config.nickname);

          if (val !== undefined) {
            if (config.nickname === val[i].nickname) {
              console.log("username taken");
              taken = true;
            }
          }
          return taken;
        }
        */
      })
      .then(val => {
        if (val !== true) {
          _8a1‍.g.console.log("a");
        } else {
          _8a1‍.g.console.log("b");
        }
      })
      .catch(val => _8a1‍.g.console.log(val));

    player = new (_8a1‍.a("Player",Player))({
      socketId: socket.id,
      nickname: config.nickname,
      pass: config.password
    });

    socket.emit("newUserCreated", {});
  });

  socket.on("game-start", config => {
    _8a1‍.g.console.log("socket on game-start");
    /*
    player = new Player({
      socketId: socket.id,
      nickname: config.nickname,
      pass: config.password
    });
    
    let playerData = db
      .get("Players")
      .find({ nickname: player.nickname, pass: player.pass })
      .value();
    console.log(":::: " + playerData);
    if (playerData !== undefined) {
      playerData.id = player.id;
      player.x = playerData.x;
      player.y = playerData.y;
      player.width = playerData.width;
      player.height = playerData.height;
      player.angle = playerData.angle;
      player.speed = playerData.speed;
      player.rotationSpeed = playerData.rotationSpeed;
      player.nickname = playerData.nickname;
      player.pass = playerData.pass;
      player.maxHealth = playerData.maxHealth;
      player.point = playerData.point;
      player.Level = playerData.Level;
      player.Exp = playerData.Exp;
      player.Attack = playerData.Attack;
      player.Defense = playerData.Defense;
    }
    */
    _8a1‍.a("players",players)[player.id] = player;

    //players[player.id].save();
    //db.get("Players")
    //  .push(players[player.id].jso())
    //  .write();
  });
  socket.on("movement", function(movement) {
    if (!player || player.health === 0) {
      return;
    }
    player.movement = movement;
  });
  socket.on("shoot", function() {
    if (!player || player.health === 0) {
      return;
    }
    player.shoot();
  });
  socket.on("disconnect", reason => {
    _8a1‍.g.console.log(socket.id + " disconnect " + reason);
    if (!player) {
      return;
    }
    _8a1‍.a("players",players)[player.id].save();
    delete _8a1‍.a("players",players)[player.id];
    player = null;
  });
});

/** Update all sockets */
setInterval(() => {
  /*
  Object.values(players).forEach(player => {
    const movement = player.movement;
    if (movement.forward) {
      player.move(player.speed);
    }
    if (movement.back) {
      player.move(-player.speed);
    }
    if (movement.left) {
      player.angle -= player.rotationSpeed;
    }
    if (movement.right) {
      player.angle += player.rotationSpeed;
    }
  });
  Object.values(bullets).forEach(bullet => {
    if (!bullet.move(bullet.speed)) {
      bullet.remove();
      return;
    }
    Object.values(players).forEach(player => {
      if (bullet.intersect(player)) {
        if (player !== bullet.player) {
          player.damage();
          bullet.remove();
          bullet.player.point += 1;
        }
      }
    });
  });
  */
  _8a1‍.a("updatePlayers",updatePlayers)();
  _8a1‍.a("updateBullets",updateBullets)();
  io.sockets.emit("state", _8a1‍.a("players",players), _8a1‍.a("bullets",bullets), _8a1‍.a("walls",walls));
}, 1000 / 20);

app.use("/static", _8a1‍.a("express",express).static(__dirname + "/static"));

app.get("/", (request, response) => {
  response.sendFile(_8a1‍.a("path",path).join(__dirname, "/static/3d.html"));
});

const port = 3000;

server.listen(port, () => {
  _8a1‍.g.console.log(`Starting server on port ${port}`);
});
