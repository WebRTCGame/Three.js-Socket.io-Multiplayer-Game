"main";"use strict";;_398‍.x([["io",()=>io],["savePlayer",()=>savePlayer]]);let express;_398‍.w("express",[["default",["express"],function(v){express=v}]]);let http;_398‍.w("http",[["default",["http"],function(v){http=v}]]);let path;_398‍.w("path",[["default",["path"],function(v){path=v}]]);let socketIO;_398‍.w("socket.io",[["default",["socketIO"],function(v){socketIO=v}]]);let fs;_398‍.w("fs.promises",[["default",["fs"],function(v){fs=v}]]);let players,bullets,walls;_398‍.w("./modules/Game.js",[["players",["players"],function(v){players=v}],["bullets",["bullets"],function(v){bullets=v}],["walls",["walls"],function(v){walls=v}]]);let Player;_398‍.w("./modules/Player.js",[["Player",["Player"],function(v){Player=v}]]);let BotPlayer;_398‍.w("./modules/BotPlayer.js",[["BotPlayer",["BotPlayer"],function(v){BotPlayer=v}]]);
_398‍.g.console.log(process.version);




const app = express();
const server = http.Server(app);
       const io = socketIO(server);

const { promises } = fs;

let dataPath = path.join(process.cwd(), "data");
let fileKey = "4nk22tdINY";

function getDbPath(user) {
  return path.join("./data", user + fileKey + ".json");
}



async function readDataDirectory() {
  return await promises.readdir("./data");
}

async function readDataFile(filename){
  return await promises.readFile(path.join("./data",filename), "utf8");
};
async function returnDataFile(filename){
  await readDataFile(filename).then(x=>{return x});
}
readDataDirectory().then(data => {
  
  readDataFile(data[0]).then(xyz=>{_398‍.g.console.log(xyz)});
  
});






const bot = new BotPlayer({ nickname: "bot" });

players[bot.id] = bot;

       let savePlayer = function(player) {
  let jso = player.jso();
  let playerData = db
    .get("Players")
    .find({ nickname: player.nickname, pass: player.pass })
    .assign({
      id: player.id,
      Ttl: Date.now(),
      x: player.x,
      y: player.y,
      width: player.width,
      height: player.height,
      angle: player.angle,
      speed: player.speed,
      rotationSpeed: player.rotationSpeed,
      nickname: player.nickname,
      pass: player.pass,
      maxHealth: player.maxHealth,
      point: player.point,
      Level: player.Level,
      Exp: player.Exp,
      Attack: player.Attack,
      Defense: player.Defense
    })
    .write();
};

io.on("connection", function(socket) {
  _398‍.g.console.log("io.on connection");
  let player = null;

  socket.on("game-start", config => {
    _398‍.g.console.log("socket on game-start");
    player = new Player({
      socketId: socket.id,
      nickname: config.nickname,
      pass: config.password
    });

    let playerData = db
      .get("Players")
      .find({ nickname: player.nickname, pass: player.pass })
      .value();
    _398‍.g.console.log(":::: " + playerData);
    if (playerData !== undefined) {
      playerData.id = player.id;
      player.x = playerData.x;
      player.y = playerData.y;
      player.width = playerData.width;
      player.height = playerData.height;
      player.angle = playerData.angle;
      player.speed = playerData.speed;
      player.rotationSpeed = playerData.rotationSpeed;
      player.nickname = playerData.nickname;
      player.pass = playerData.pass;
      player.maxHealth = playerData.maxHealth;
      player.point = playerData.point;
      player.Level = playerData.Level;
      player.Exp = playerData.Exp;
      player.Attack = playerData.Attack;
      player.Defense = playerData.Defense;
    }
    players[player.id] = player;

    //players[player.id].save();
    db.get("Players")
      .push(players[player.id].jso())
      .write();
  });
  socket.on("movement", function(movement) {
    if (!player || player.health === 0) {
      return;
    }
    player.movement = movement;
  });
  socket.on("shoot", function() {
    if (!player || player.health === 0) {
      return;
    }
    player.shoot();
  });
  socket.on("disconnect", () => {
    if (!player) {
      return;
    }
    players[player.id].save();
    delete players[player.id];
    player = null;
  });
});

setInterval(() => {
  Object.values(players).forEach(player => {
    const movement = player.movement;
    if (movement.forward) {
      player.move(player.speed);
    }
    if (movement.back) {
      player.move(-player.speed);
    }
    if (movement.left) {
      player.angle -= player.rotationSpeed;
    }
    if (movement.right) {
      player.angle += player.rotationSpeed;
    }
  });
  Object.values(bullets).forEach(bullet => {
    if (!bullet.move(bullet.speed)) {
      bullet.remove();
      return;
    }
    Object.values(players).forEach(player => {
      if (bullet.intersect(player)) {
        if (player !== bullet.player) {
          player.damage();
          bullet.remove();
          bullet.player.point += 1;
        }
      }
    });
  });
  io.sockets.emit("state", players, bullets, walls);
}, 1000 / 20);

app.use("/static", express.static(__dirname + "/static"));

app.get("/", (request, response) => {
  response.sendFile(path.join(__dirname, "/static/3d.html"));
});

const port = 3000;
server.listen(port, () => {
  _398‍.g.console.log(`Starting server on port ${port}`);
});
